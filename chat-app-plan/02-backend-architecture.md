# 后端架构设计

## 系统架构概览

聊天软件后端采用微服务架构，基于Spring Cloud构建，分为多个独立的服务模块，通过消息队列和API网关实现服务间通信和外部访问。

## 服务拆分

### 1. API网关服务

**功能职责**：
- 请求路由与负载均衡
- 统一认证与授权
- 限流与熔断
- 请求/响应日志
- API版本管理
- WebSocket连接管理

**主要组件**：
- Spring Cloud Gateway
- Spring Security
- Redis (限流)

### 2. 用户认证服务

**功能职责**：
- 用户注册与登录
- JWT令牌生成与验证
- OAuth2第三方登录
- 用户密码重置
- 多设备管理
- 登录安全策略

**关键组件**：
- Spring Security
- JWT
- Redis

### 3. 用户服务

**功能职责**：
- 用户资料管理
- 联系人/好友关系管理
- 组织与部门管理
- 用户搜索
- 用户状态管理

**主要组件**：
- Spring Boot
- MySQL
- Redis (缓存)

### 4. 聊天服务

**功能职责**：
- 消息收发处理
- 会话管理
- 群组管理
- 消息存储与检索
- 消息状态跟踪

**关键组件**：
- Spring Boot
- WebSocket
- MQTT (可选)
- RocketMQ/Kafka
- MySQL
- Redis

### 5. 文件服务

**功能职责**：
- 图片、语音、视频等文件上传
- 文件存储管理
- 文件预览与下载
- 缩略图生成
- 文件格式转换

**主要组件**：
- Spring Boot
- MinIO/AWS S3
- FFmpeg (媒体处理)

### 6. 推送服务

**功能职责**：
- 离线消息推送
- 通知管理
- 推送渠道管理 (APNS, FCM等)
- 推送策略控制

**关键组件**：
- Spring Boot
- RocketMQ/Kafka
- Redis

### 7. 搜索服务

**功能职责**：
- 消息全文检索
- 索引管理
- 搜索结果处理与排序

**主要组件**：
- Spring Boot
- Elasticsearch

### 8. 管理服务

**功能职责**：
- 用户管理
- 组织管理
- 权限管理
- 系统配置
- 运营数据统计

**主要组件**：
- Spring Boot
- MySQL
- Redis

## WebSocket实时通信设计

### 连接流程

1. **建立连接**：
   - 客户端通过API网关建立WebSocket连接
   - 网关进行认证验证
   - 连接成功后，将连接信息存储在Redis中

2. **会话管理**：
   - 用户上线时，更新用户状态
   - 维护用户-连接映射关系
   - 处理心跳包保持连接
   - 异常断开时的重连策略

3. **消息传递**：
   - 消息格式定义（JSON格式）
   - 消息加密传输
   - 消息确认机制
   - 消息排序与重复检查

### 消息协议设计

基本消息格式：

```json
{
  "id": "唯一消息ID",
  "type": "消息类型",
  "senderId": "发送者ID",
  "receiverId": "接收者ID(单聊)/会话ID(群聊)",
  "content": "消息内容/媒体URL",
  "contentType": "内容类型(text/image/voice/video/file)",
  "timestamp": "时间戳",
  "ext": { /*扩展字段*/ }
}
```

消息类型：
- `CHAT`: 聊天消息
- `ACK`: 消息确认
- `RECALL`: 消息撤回
- `TYPING`: 正在输入
- `STATUS`: 状态变更
- `SYSTEM`: 系统通知

### 消息流转流程

1. **消息发送**：
   - 客户端通过WebSocket发送消息
   - 服务器接收并验证消息格式
   - 生成唯一消息ID并入库
   - 返回ACK确认

2. **消息分发**：
   - 根据接收者查找活跃连接
   - 在线用户：直接通过WebSocket推送
   - 离线用户：存入离线消息队列并触发推送服务

3. **消息持久化**：
   - 消息存入MySQL数据库
   - 消息索引进入Elasticsearch
   - 会话最新消息更新

4. **消息状态更新**：
   - 发送状态：发送中 -> 已发送 -> 已送达 -> 已读
   - 每一步状态变化都需要实时同步给发送方

### 离线消息处理

1. 用户离线时，新消息进入离线消息队列
2. 用户上线时，拉取离线消息并推送
3. 定期清理已读的离线消息

## 消息队列设计

使用RocketMQ/Kafka作为消息队列，处理以下场景：

1. **消息转发队列**：
   - 接收聊天服务发来的消息
   - 异步分发给不同的接收端

2. **通知推送队列**：
   - 处理需要推送的系统通知
   - 触发推送服务向移动设备发送推送

3. **文件处理队列**：
   - 接收上传的多媒体文件
   - 异步处理图片缩略图、视频转码等

4. **事件队列**：
   - 处理用户状态变更事件
   - 处理会话更新事件
   - 处理消息状态变更事件

## API设计

采用RESTful风格API设计，主要接口路径规划：

### 用户相关

```
POST   /api/v1/auth/register         # 注册
POST   /api/v1/auth/login            # 登录
POST   /api/v1/auth/logout           # 登出
GET    /api/v1/auth/token/refresh    # 刷新token

GET    /api/v1/users/me              # 获取当前用户信息
PUT    /api/v1/users/me              # 更新用户信息
GET    /api/v1/users/{id}            # 获取用户信息
GET    /api/v1/users/search          # 搜索用户

GET    /api/v1/contacts              # 获取联系人列表
POST   /api/v1/contacts              # 添加联系人
DELETE /api/v1/contacts/{id}         # 删除联系人
PUT    /api/v1/contacts/{id}/remark  # 设置备注

GET    /api/v1/friend-requests       # 获取好友请求
POST   /api/v1/friend-requests       # 发送好友请求
PUT    /api/v1/friend-requests/{id}  # 处理好友请求
```

### 聊天相关

```
GET    /api/v1/conversations              # 获取会话列表
POST   /api/v1/conversations              # 创建会话
GET    /api/v1/conversations/{id}         # 获取会话详情
DELETE /api/v1/conversations/{id}         # 删除会话

GET    /api/v1/conversations/{id}/messages  # 获取会话消息
POST   /api/v1/messages                   # 发送消息(非实时)
DELETE /api/v1/messages/{id}              # 删除消息
PUT    /api/v1/messages/{id}/recall       # 撤回消息
PUT    /api/v1/messages/{id}/read         # 标记已读

GET    /api/v1/groups                     # 获取群组列表
POST   /api/v1/groups                     # 创建群组
GET    /api/v1/groups/{id}                # 获取群组信息
PUT    /api/v1/groups/{id}                # 更新群组信息
DELETE /api/v1/groups/{id}                # 解散群组
POST   /api/v1/groups/{id}/members        # 添加群成员
DELETE /api/v1/groups/{id}/members/{uid}  # 移除群成员
```

### 文件相关

```
POST   /api/v1/files/upload           # 上传文件
GET    /api/v1/files/{id}             # 获取文件
GET    /api/v1/files/{id}/thumbnail   # 获取缩略图
```

### 管理相关

```
GET    /api/v1/admin/users            # 管理员获取用户列表
PUT    /api/v1/admin/users/{id}/status # 修改用户状态
GET    /api/v1/admin/organizations    # 获取组织列表
POST   /api/v1/admin/organizations    # 创建组织
```

## 安全设计

### 认证机制

1. **JWT认证**：
   - 登录成功后颁发JWT令牌
   - 令牌包含用户ID、角色、过期时间等信息
   - 短期访问令牌(Access Token)和长期刷新令牌(Refresh Token)

2. **多设备支持**：
   - 每个设备使用独立的令牌
   - 可以远程注销特定设备的令牌

### 数据安全

1. **传输安全**：
   - 全站HTTPS加密
   - WebSocket使用WSS加密连接
   - 敏感数据传输额外加密

2. **存储安全**：
   - 用户密码采用bcrypt/Argon2加密存储
   - 敏感信息加密存储
   - 定期数据安全审计

3. **端到端加密(可选)**：
   - 使用非对称加密技术
   - 私钥客户端保存，服务端只存储公钥
   - 群聊使用群密钥加密消息

### 安全防护

1. **API保护**：
   - 请求频率限制
   - 异常IP检测与封禁
   - API版本控制

2. **防注入攻击**：
   - SQL参数化查询
   - XSS过滤
   - CSRF防护

3. **安全监控**：
   - 异常登录行为监控
   - 敏感操作审计日志
   - 定期安全漏洞扫描

## 系统部署架构

### 开发环境

```
+----------------------------------+
|         本地开发环境              |
|  Docker Compose运行所有服务和依赖  |
+----------------------------------+
```

### 测试环境

```
+---------------------------+
|     单集群K8s部署         |
|  服务单副本，共享数据库    |
+---------------------------+
```

### 生产环境

```
                    +------------------+
                    |    负载均衡器     |
                    +--------+---------+
                             |
        +-------------------+|+-------------------+
        |                   ||                    |
+-------v------+    +-------v------+    +---------v----+
| API网关集群   |    | API网关集群   |    | API网关集群   |
+-------+------+    +-------+------+    +-------+------+
        |                   |                   |
        v                   v                   v
+--------------------------------------------------+
|                 服务网格 (Service Mesh)           |
+--------------------------------------------------+
        |                   |                   |
        v                   v                   v
+---------------+   +----------------+   +---------------+
| 用户服务集群   |   | 聊天服务集群    |   | 其他服务集群   |
+-------+-------+   +--------+-------+   +-------+-------+
        |                    |                   |
        v                    v                   v
+--------------------------------------------------+
|                分布式数据存储层                    |
|    MySQL集群 + Redis集群 + ES集群 + 分布式存储     |
+--------------------------------------------------+
```

### 容灾设计

1. **多区域部署**：
   - 两地三中心部署策略
   - 区域间数据实时同步

2. **高可用设计**：
   - 服务多副本部署
   - 数据库主从冗余
   - 存储数据多副本

3. **灾难恢复**：
   - 定期数据备份
   - 灾难恢复演练
   - 应急预案

## 性能优化策略

1. **分库分表**：
   - 消息表按会话ID水平分表
   - 历史消息按时间分表

2. **缓存优化**：
   - 多级缓存策略
   - 热点数据预加载
   - 读写分离

3. **连接优化**：
   - WebSocket连接池
   - 长连接保活策略
   - 连接监控与自动修复

4. **集群扩展**：
   - 服务水平扩展能力
   - 自动扩缩容策略
   - 资源使用监控
