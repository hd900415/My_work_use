# =========================
# Namespace
# =========================
apiVersion: v1
kind: Namespace
metadata:
  name: rocketmq-cluster
---
# =========================
# NameServer Services
# - rocketmq-namesrv: 给 dashboard / broker 用
# - rocketmq-namesrv-headless: 用于拼接 namesrvAddr 列表
# =========================
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-namesrv
  namespace: rocketmq-cluster
spec:
  type: ClusterIP
  selector:
    app: rocketmq
    component: namesrv
  ports:
    - name: namesrv
      port: 9876
      targetPort: 9876
---
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-namesrv-headless
  namespace: rocketmq-cluster
spec:
  clusterIP: None
  selector:
    app: rocketmq
    component: namesrv
  ports:
    - name: namesrv
      port: 9876
      targetPort: 9876
---
# =========================
# NameServer StatefulSet (3)
# =========================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rocketmq-namesrv
  namespace: rocketmq-cluster
spec:
  serviceName: rocketmq-namesrv-headless
  replicas: 3
  selector:
    matchLabels:
      app: rocketmq
      component: namesrv
  template:
    metadata:
      labels:
        app: rocketmq
        component: namesrv
    spec:
      terminationGracePeriodSeconds: 30
      containers:
        - name: namesrv
          image: apache/rocketmq:5.3.4
          imagePullPolicy: IfNotPresent
          command: ["sh","mqnamesrv"]
          ports:
            - containerPort: 9876
              name: namesrv
          readinessProbe:
            tcpSocket:
              port: 9876
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 9876
            initialDelaySeconds: 30
            periodSeconds: 10
          resources:
            requests:
              cpu: "1"
              memory: "1Gi"
            limits:
              cpu: "2"
              memory: "2Gi"
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname
                labelSelector:
                  matchLabels:
                    app: rocketmq
                    component: namesrv
---
# =========================
# Broker config template（一个模板给所有 broker set 用）
# =========================
apiVersion: v1
kind: ConfigMap
metadata:
  name: rocketmq-broker-template
  namespace: rocketmq-cluster
data:
  broker.conf.tpl: |
    brokerClusterName=rmq-cluster
    brokerName=${BROKER_NAME}
    brokerId=${BROKER_ID}
    brokerRole=${BROKER_ROLE}
    flushDiskType=ASYNC_FLUSH

    brokerIP1=${POD_IP}

    storePathRootDir=/home/rocketmq/store
    storePathCommitLog=/home/rocketmq/store/commitlog

    namesrvAddr=${NAMESRV_ADDR}

    autoCreateTopicEnable=true
    autoCreateSubscriptionGroup=true
    deleteWhen=04
    fileReservedTime=48
---
# =========================
# BrokerSet A Services（headless + clusterIP）
# - headless：有稳定 DNS（未来你要做 per-pod 暴露也方便）
# =========================
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-broker-a
  namespace: rocketmq-cluster
spec:
  type: ClusterIP
  selector:
    app: rocketmq
    component: broker
    brokerset: a
  ports:
    - name: broker
      port: 10911
      targetPort: 10911
    - name: ha
      port: 10912
      targetPort: 10912
    - name: fast-remoting
      port: 10909
      targetPort: 10909
---
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-broker-a-headless
  namespace: rocketmq-cluster
spec:
  clusterIP: None
  selector:
    app: rocketmq
    component: broker
    brokerset: a
  ports:
    - name: broker
      port: 10911
      targetPort: 10911
    - name: ha
      port: 10912
      targetPort: 10912
    - name: fast-remoting
      port: 10909
      targetPort: 10909
---
# =========================
# BrokerSet A StatefulSet (1M1S => replicas=2)
# ordinal 0 => Master, ordinal 1 => Slave
# =========================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rocketmq-broker-a
  namespace: rocketmq-cluster
spec:
  serviceName: rocketmq-broker-a-headless
  replicas: 2
  selector:
    matchLabels:
      app: rocketmq
      component: broker
      brokerset: a
  template:
    metadata:
      labels:
        app: rocketmq
        component: broker
        brokerset: a
    spec:
      terminationGracePeriodSeconds: 60
      securityContext:
        fsGroup: 3000
      initContainers:
        - name: render-broker-conf
          image: apache/rocketmq:5.3.4
          imagePullPolicy: IfNotPresent
          env:
            - name: BROKER_NAME
              value: "broker-a"
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: NAMESRV_ADDR
              value: "rocketmq-namesrv-0.rocketmq-namesrv-headless:9876;rocketmq-namesrv-1.rocketmq-namesrv-headless:9876;rocketmq-namesrv-2.rocketmq-namesrv-headless:9876"
          command:
            - sh
            - -c
            - |
              set -e
              ORD="${HOSTNAME##*-}"
              if [ "$ORD" = "0" ]; then
                ROLE="ASYNC_MASTER"
              else
                ROLE="SLAVE"
              fi
              cp /cm/broker.conf.tpl /work/broker.conf
              sed -i "s|\${BROKER_NAME}|${BROKER_NAME}|g" /work/broker.conf
              sed -i "s|\${BROKER_ID}|${ORD}|g" /work/broker.conf
              sed -i "s|\${BROKER_ROLE}|${ROLE}|g" /work/broker.conf
              sed -i "s|\${POD_IP}|${POD_IP}|g" /work/broker.conf
              sed -i "s|\${NAMESRV_ADDR}|${NAMESRV_ADDR}|g" /work/broker.conf
          volumeMounts:
            - name: broker-cm
              mountPath: /cm
            - name: broker-conf
              mountPath: /work
      containers:
        - name: broker
          image: apache/rocketmq:5.3.4
          imagePullPolicy: IfNotPresent
          env:
            - name: JAVA_OPT_EXT
              value: "-Xms2g -Xmx2g -XX:MaxDirectMemorySize=1g"
          command: ["sh","mqbroker","-c","/home/rocketmq/conf/broker.conf"]
          ports:
            - containerPort: 10911
              name: broker
            - containerPort: 10912
              name: ha
            - containerPort: 10909
              name: fast-remoting
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "2"
              memory: "4Gi"
          readinessProbe:
            tcpSocket:
              port: 10911
            initialDelaySeconds: 25
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 10911
            initialDelaySeconds: 60
            periodSeconds: 20
          volumeMounts:
            - name: broker-store
              mountPath: /home/rocketmq/store
            - name: broker-conf
              mountPath: /home/rocketmq/conf
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  app: rocketmq
                  component: broker
                  brokerset: a 
      volumes:
        - name: broker-conf
          emptyDir: {}
        - name: broker-cm
          configMap:
            name: rocketmq-broker-template
  volumeClaimTemplates:
    - metadata:
        name: broker-store
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: gp3
        resources:
          requests:
            storage: 50Gi
---
# =========================
# BrokerSet B Services + StatefulSet (同 A，改成 broker-b)
# =========================
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-broker-b
  namespace: rocketmq-cluster
spec:
  type: ClusterIP
  selector:
    app: rocketmq
    component: broker
    brokerset: b
  ports:
    - name: broker
      port: 10911
      targetPort: 10911
    - name: ha
      port: 10912
      targetPort: 10912
    - name: fast-remoting
      port: 10909
      targetPort: 10909
---
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-broker-b-headless
  namespace: rocketmq-cluster
spec:
  clusterIP: None
  selector:
    app: rocketmq
    component: broker
    brokerset: b
  ports:
    - name: broker
      port: 10911
      targetPort: 10911
    - name: ha
      port: 10912
      targetPort: 10912
    - name: fast-remoting
      port: 10909
      targetPort: 10909
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rocketmq-broker-b
  namespace: rocketmq-cluster
spec:
  serviceName: rocketmq-broker-b-headless
  replicas: 2
  selector:
    matchLabels:
      app: rocketmq
      component: broker
      brokerset: b
  template:
    metadata:
      labels:
        app: rocketmq
        component: broker
        brokerset: b
    spec:
      terminationGracePeriodSeconds: 60
      securityContext:
        fsGroup: 3000
      initContainers:
        - name: render-broker-conf
          image: apache/rocketmq:5.3.4
          imagePullPolicy: IfNotPresent
          env:
            - name: BROKER_NAME
              value: "broker-b"
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: NAMESRV_ADDR
              value: "rocketmq-namesrv-0.rocketmq-namesrv-headless:9876;rocketmq-namesrv-1.rocketmq-namesrv-headless:9876;rocketmq-namesrv-2.rocketmq-namesrv-headless:9876"
          command:
            - sh
            - -c
            - |
              set -e
              ORD="${HOSTNAME##*-}"
              if [ "$ORD" = "0" ]; then
                ROLE="ASYNC_MASTER"
              else
                ROLE="SLAVE"
              fi
              cp /cm/broker.conf.tpl /work/broker.conf
              sed -i "s|\${BROKER_NAME}|${BROKER_NAME}|g" /work/broker.conf
              sed -i "s|\${BROKER_ID}|${ORD}|g" /work/broker.conf
              sed -i "s|\${BROKER_ROLE}|${ROLE}|g" /work/broker.conf
              sed -i "s|\${POD_IP}|${POD_IP}|g" /work/broker.conf
              sed -i "s|\${NAMESRV_ADDR}|${NAMESRV_ADDR}|g" /work/broker.conf
          volumeMounts:
            - name: broker-cm
              mountPath: /cm
            - name: broker-conf
              mountPath: /work
      containers:
        - name: broker
          image: apache/rocketmq:5.3.4
          imagePullPolicy: IfNotPresent
          env:
            - name: JAVA_OPT_EXT
              value: "-Xms2g -Xmx2g -XX:MaxDirectMemorySize=1g"
          command: ["sh","mqbroker","-c","/home/rocketmq/conf/broker.conf"]
          ports:
            - containerPort: 10911
              name: broker
            - containerPort: 10912
              name: ha
            - containerPort: 10909
              name: fast-remoting
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "2"
              memory: "4Gi"
          readinessProbe:
            tcpSocket:
              port: 10911
            initialDelaySeconds: 25
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 10911
            initialDelaySeconds: 60
            periodSeconds: 20
          volumeMounts:
            - name: broker-store
              mountPath: /home/rocketmq/store
            - name: broker-conf
              mountPath: /home/rocketmq/conf
      volumes:
      - name: broker-conf
        emptyDir: {}
      - name: broker-cm
        configMap:
          name: rocketmq-broker-template
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  app: rocketmq
                  component: broker
                  brokerset: b
  volumeClaimTemplates:
    - metadata:
        name: broker-store
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: gp3
        resources:
          requests:
            storage: 50Gi
---
# =========================
# Dashboard
# =========================
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-dashboard
  namespace: rocketmq-cluster
spec:
  type: ClusterIP
  selector:
    app: rocketmq
    component: dashboard
  ports:
    - name: http
      port: 8080
      targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rocketmq-dashboard
  namespace: rocketmq-cluster
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rocketmq
      component: dashboard
  template:
    metadata:
      labels:
        app: rocketmq
        component: dashboard
    spec:
      containers:
        - name: dashboard
          image: apacherocketmq/rocketmq-dashboard:2.0.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: JAVA_OPTS
              value: "-Drocketmq.config.namesrvAddr=rocketmq-namesrv:9876"
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 20
---
apiVersion: networking.k8s.io/v1 
kind: NetworkPolicy
metadata:
  name: rocketmq-egress-restrict
  namespace: rocketmq-cluster
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS to kube-dns/CoreDNS in kube-system
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow all traffic within the rocketmq-cluster namespace (namesrv/broker/dashboard互通)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: rocketmq-cluster

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rocketmq-egress-allow-kube-dns-alt-label
  namespace: rocketmq-cluster
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Some clusters label CoreDNS as eks-app=kube-dns; this is a fallback.
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              eks-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rocketmq-dashboard-ingress
  namespace: rocketmq-cluster
  annotations:
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-southeast-1:311456830418:certificate/ded5fb5e-abec-4c18-a192-1b019796a52a
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/target-type: ip
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/inbound-cidrs: 123.20.82.199/32,18.142.150.168/32
spec:
  ingressClassName: alb
  rules:
    - host: rocketmqdashboard-nwprod.newworld-uat.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: rocketmq-dashboard
                port:
                  number: 8080
